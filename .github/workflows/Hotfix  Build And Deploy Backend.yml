name: Hotfix Build And Deploy Backend

on:
  workflow_dispatch:
  #push:
   #branches: [ hotfix/production_bug_fixes ] 
  #pull_request:
    #branches: [ hotfix/production_bug_fixes ]

env:
  commitmsg: ${{ github.event.head_commit.message }}     

jobs:
  Hotflix1-Backend-Build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/hotfix/production_bug_fixes'
    name: Hotfix Backend Build
    steps:
      - name: Checking out gms-service repo
        uses: actions/checkout@v2
        with:
          repository: jayanth9652/gms-service
          token: ${{ secrets.MY_PAT }}
          ref: hotfix/production_bug_fixes
      - run: pwd
      - run: ls -lrt
      - run: ./gradlew bootJar
      - run: pwd
      - run: ls -lrt

      - name: uploading anudan backend artifact
        uses: actions/upload-artifact@master
        with:
          name: Anudan-backend-artifact
          path: build/libs/gms-service-0.0.1-SNAPSHOT.jar
          retention-days: 5

  unit-and-functional-testing-Backend:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/hotfix/production_bug_fixes'
    name: unit and functional testing Backend
    steps: 
    - name: checking out gms-service repo
      uses: actions/checkout@v2
      with:
          repository: jayanth9652/gms-service
          token: ${{ secrets.MY_PAT }}
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
          java-version: 1.8      
    - name: test backend code(functional)
      run: |
        ls -l
        ./gradlew test jacocoTestReport
  Static-Code-Analysis-Sonarqube-Backend:
     runs-on: ubuntu-latest
     name: Static Code Analysis Sonarqube  hotfix/production_bug_fixes Backend
     if: github.ref == 'refs/heads/hotfix/production_bug_fixes'
     steps:
     - uses: actions/checkout@v2
       with:
        # Disabling shallow clone is recommended for improving relevancy of reporting
        fetch-depth: 0
        ref: refs/heads/hotfix/production_bug_fixes
     - name: Set up JDK 11
       uses: actions/setup-java@v1
       with:
          java-version: 11
     - name: Cache SonarCloud packages
       uses: actions/cache@v1
       with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
     - name: Cache Gradle packages
       uses: actions/cache@v1
       with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
          restore-keys: ${{ runner.os }}-gradle
     - name: analyze
       env:
          GITHUB_TOKEN: ${{ secrets.MY_PAT }}  # Needed to get PR information, if any
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
       run: | 
        ./gradlew  sonarqube --info       

  Anudan-config:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/hotfix/production_bug_fixes'
    name: Anudan config
    steps: 
      - name: Checking out my anudan-config repo
        uses: actions/checkout@master
        with:
          repository: jayanth9652/anudan-config   
          token: ${{ secrets.MY_PAT }}
      - run: pwd
      - run: ls -lrt     
      - name: anudan-config artifact building
        uses: actions/upload-artifact@v2
        with:
          name: Anudan-Configuration
          path: backend/application.yaml
          retention-days: 5  
  

  Trigger-Hotfix-Release:
      runs-on: ubuntu-latest
      if: github.ref == 'refs/heads/hotfix/production_bug_fixes'  
      name: Creating Hotfix Release Version
      steps:      
        - name: Hotfix-deployment 
          uses: convictional/trigger-workflow-and-wait@v1.3.0
          with:
            owner: jayanth9652
            repo: anudan-app
            github_token: ${{ secrets.MY_PAT }}
            workflow_file_name: Hotfix-package.yml
            ref: hotfix/production_bug_fixes

  Release-repo-checkout:
      runs-on: ubuntu-latest
      if: github.ref == 'refs/heads/hotfix/production_bug_fixes'
      name: Release repo checkout
      needs: [Trigger-Hotfix-Release]
      steps:
        - uses: actions/checkout@v2
          with:
            repository: jayanth9652/release   
            token: ${{ secrets.MY_PAT }}
        - name: creating Hotfix_release.json artifact 
          uses: actions/upload-artifact@v2
          with:
            name: Anudan-Hotfix-Release
            path: release.json
            retention-days: 5           

  Rsync-Hotfix-Deployments:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/hotfix/production_bug_fixes'
    needs: [Hotflix1-Backend-Build, unit-and-functional-testing-Backend, Static-Code-Analysis-Sonarqube-Backend, Anudan-config, Release-repo-checkout]
    name: Copy Artifacts To Hotfix Server
    steps:
    - name: downloading Anudan-Configuration arifact
      uses: actions/download-artifact@v2
      with:
        name: Anudan-Configuration
    - name: downloading Anudan-backend-artifact 
      uses: actions/download-artifact@v2
      with:
        name: Anudan-backend-artifact     
    - name: downloading Anudan-Hotfix-Release artifact 
      uses: actions/download-artifact@v2
      with:
          name: Anudan-Hotfix-Release     
    - run: |  
          ls -lrt
          pwd
    - name: rsync deployments
      uses: burnett01/rsync-deployments@4.1
      with:
        switches: -avzr -q
        path: .
        remote_path: /home/anudan/github
        remote_host: ${{ secrets.HOST_HOTFIX }}
        remote_port: ${{ secrets.SSH_PORT }}
        remote_user: ${{ secrets.SSH_USER }}
        remote_key: ${{ secrets.SSH_DEPLOY_KEY }}          

  Notify-on-email:
    runs-on: ubuntu-latest
    if: always()
    needs: [Hotflix1-Backend-Build, unit-and-functional-testing-Backend, Static-Code-Analysis-Sonarqube-Backend, Anudan-config, Rsync-Hotfix-Deployments, Trigger-Hotfix-Release]
    name: EmailNotify
    steps:
      - name: Anudan Release artifact downloading      
        uses: actions/download-artifact@v2
        with:
          name: Anudan-Hotfix-Release

      - name: set env variable with bash expression 
        run:   |
         ls -lrt
         echo "Hotfix_Release=`cat release.json | cut -d "," -f3 |cut -d ":" -f2 | sed 's/"//g' |sed 's/}//g'`" >> $GITHUB_ENV
      - name: Send some mail
        uses: wadeww/send-email-action@master
        with:
          server_address: smtp.gmail.com
          port: ${{ secrets.SMTP_SERVER_PORT }}
          username: ${{ secrets.AUTH_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: Hotfix - Build Backend Workflow Finished
          body: ${{github.repository}} 


                1) Buildjob- ${{needs.Hotflix1-Backend-Build.result}} 


                2) unit and functional testing Backend - ${{needs.unit-and-functional-testing-Backend.result}} 


                3) Static Code Analysis Sonarqube  hotfix/production_bug_fixes Backend - ${{needs.Static-Code-Analysis-Sonarqube-Backend.result}}


                4) Anudan config - ${{needs.Anudan-config.result}} 


                5) Rsync Hotfix Deployments - ${{needs.Rsync-Hotfix-Deployments.result}} 


                6) Trigger Hotfix Release - ${{needs.Trigger-Hotfix-Release.result}}


                7) commit messages - ${{ env.commitmsg }}


                8) changes done by - ${{ github.actor }}

                  
                9) The name of the webhook event that triggered the workflow - ${{ github.event_name}}


                10) Anudan - Grant Management System â€º Hotfix Release - ${{ env.Hotfix_Release }}
          to: prabhu@socialalpha.org
          from: donotreply@anudan.org           
        